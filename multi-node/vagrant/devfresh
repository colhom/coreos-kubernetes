#!/bin/bash -e

if [ $# -lt 1 ];then
    echo "USAGE: $0 [etcd_nodes...]"
    exit 1
fi

for etcdNode in $@;do

    echo "devfresh: $etcdNode"

    tar cf - \
	./../generic/etcd2-backup/etcd2-restore-first \
	./../generic/etcd2-backup/*.{service,timer} \
	etcd2-spam{,.service} \
	rclone.conf \
	./../generic/etcd2-backup/etcd2-backup-restore.env \
	| vagrant ssh -c "tar xf -" "$etcdNode"

    vagrant ssh -c "
sudo systemctl stop etcd2-backup.{timer,service}; \
sudo cp ./rclone.conf /etc/ && \
sudo cp ./*.env /etc/ && \
sudo chmod 755 ./etcd2-restore-first && \
sudo mkdir -p /opt/bin && \
	sudo mv generic/etcd2-backup/*.{service,timer} /etc/systemd/system && \
	sudo mv generic/etcd2-backup/etcd2-restore-first /opt/bin && \
	sudo systemctl daemon-reload && \
sudo systemctl start etcd2 etcd2-backup.{timer,service};
" "$etcdNode"
done
